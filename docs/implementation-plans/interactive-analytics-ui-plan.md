# Implementation Plan: Interactive Analytics UI in Chatbot

**Objective**: To enhance the Mataresit chatbot's user experience by replacing plain-text financial summaries with rich, interactive UI components like charts and summary cards. This will make complex financial data more accessible and easier to understand at a glance.

---

## Phase 1: Structured Data Response Format

The first step is to evolve the RAG pipeline's output from a simple string to a structured JSON object. This will provide the frontend with both a natural language summary and the data needed for visualization.

### 1.1. Define New Response Type

In `lib/chat-response-generator.ts`, we will define a new `AnalyticalResponse` interface:

```typescript
export type VisualizationType = 'bar_chart' | 'line_chart' | 'summary_cards' | 'none';

export interface AnalyticalResponse {
  summary: string; // The natural language summary generated by the LLM
  visualization: {
    type: VisualizationType;
    title: string;
    data: any; // The raw data for the chart or cards
  };
}
```

### 1.2. Update the Analytics Handler

The `handleAnalyticalQuery` function will be modified to:
1.  Retrieve the raw analytics data from the database as it does now.
2.  Generate the natural language `summary` using the LLM.
3.  Construct the `AnalyticalResponse` object, packaging the summary, visualization type, a suitable title, and the raw data.
4.  Return the `AnalyticalResponse` object serialized as a JSON string. This ensures it can be transmitted as the message content.

---

## Phase 2: UI Component Development

Next, we will develop a set of reusable React components to render the visualizations. These will be placed in a new `src/components/analytics/` directory.

### 2.1. Add Charting Library

We will add a lightweight and powerful charting library to the project. `recharts` is a strong candidate due to its composable and declarative components.

```bash
npm install recharts
```

### 2.2. Create Visualization Components

We will create the following components:

-   `SpendingBarChart.tsx`: A bar chart to visualize spending by category.
-   `TrendsLineChart.tsx`: A line chart to display monthly spending trends.
-   `AnalyticsSummaryCard.tsx`: A flexible component to display key metrics for merchant analysis or spending anomalies.

These components will be designed to accept the `data` from the `AnalyticalResponse` as props and render the appropriate visualization.

---

## Phase 3: Chat UI Integration

The final phase is to teach the chat interface how to render these new components.

### 3.1. Create a Component Renderer

We will create a new component, `AnalyticsRenderer.tsx`, that will act as a router. It will:
1.  Accept the `AnalyticalResponse` object as a prop.
2.  Use a `switch` statement on the `visualization.type` to render the correct chart or card component, passing the `title` and `data` down as props.

### 3.2. Update the Chat Message Component

The `ChatMessage.tsx` component in `src/components/chat/` will be updated:

1.  When rendering a message from the `assistant`, it will attempt to parse the `content` string as JSON.
2.  A `try-catch` block will handle the parsing. If successful and the object matches the `AnalyticalResponse` structure, it will render the `AnalyticsRenderer` component.
3.  If parsing fails or the object is not the expected type, it will fall back to rendering the `content` as plain text (with Markdown formatting), ensuring backward compatibility and graceful error handling.

This approach avoids cluttering the `ChatMessage` component with complex rendering logic and keeps the system modular and extensible.

---

## Testing Strategy

-   **Unit Tests**: Write unit tests for each new analytics component to ensure they render correctly with various data inputs.
-   **Integration Tests**: Test the `AnalyticsRenderer` to ensure it correctly maps response types to components.
-   **End-to-End (E2E) Tests**: Manually test the full flow by sending analytical queries to the chatbot and verifying that the correct interactive UI component is displayed in the chat history.
